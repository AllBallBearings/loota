<!DOCTYPE html>
<html>
  <head>
    <title>Loota AR View</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #info {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        z-index: 100;
        max-width: 80%;
      }
      #distance-indicator {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        z-index: 100;
      }
      #compass {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Arial, sans-serif;
        z-index: 100;
      }
      .hidden {
        display: none !important;
      }
      .a-enter-vr {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="info">Initializing AR...</div>
    <div id="distance-indicator">Distance to cube: calculating...</div>
    <div id="compass" class="hidden">N</div>

    <!-- Import libraries in correct order -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/v6/dist/aframe-extras.loaders.min.js"></script>

    <!-- A-Frame scene with GPS AR -->
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; sourceWidth: 1280; sourceHeight: 960;"
      vr-mode-ui="enabled: false"
      gps-scene
      renderer="logarithmicDepthBuffer: true; precision: high;"
    >
      <!-- Camera -->
      <a-entity gps-camera rotation-reader></a-entity>

      <!-- GPS Anchored Cube -->
      <a-entity
        id="ar-cube"
        gps-entity-place="latitude: 0; longitude: 0;"
        scale="0.3 0.3 0.3"
      >
        <a-box
          position="0 1.6 0"
          rotation="0 0 0"
          material="color: #ff0000; metalness: 0.5; roughness: 0.5; emissive: #ff0000; emissiveIntensity: 0.2"
          animation="property: rotation; dur: 8000; to: 360 360 0; loop: true; easing: linear"
        ></a-box>
        <a-sphere
          position="0 1.4 0"
          scale="0.1 0.02 0.1"
          material="color: #ff0000; opacity: 0.5; transparent: true"
          animation="property: scale; dir: alternate; dur: 1000; to: 0.15 0.02 0.15; loop: true"
        ></a-sphere>
      </a-entity>
    </a-scene>

    <script>
      let userLocation = null;
      let cubeEntity = document.getElementById("ar-cube");
      const CUBE_DISTANCE = 2.1336; // 7 feet in meters

      async function initializeAR() {
        try {
          // Get initial position
          const position = await getGeolocation();
          userLocation = position.coords;

          // Set cube position 2 meters south
          const cubeCoords = calculateOffsetPosition(
            userLocation.latitude,
            userLocation.longitude,
            CUBE_DISTANCE,
            180
          );

          // Update GPS entity place coordinates
          cubeEntity.setAttribute("gps-entity-place", {
            latitude: cubeCoords.latitude,
            longitude: cubeCoords.longitude,
          });

          // Initialize compass
          initCompass();

          updateStatus("AR Ready - Look through your device");
          startDistanceUpdates();
        } catch (error) {
          console.error("AR initialization failed:", error);
          updateStatus("Failed to initialize AR: " + error.message);
        }
      }

      function getGeolocation() {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 5000,
          });
        });
      }

      function calculateOffsetPosition(lat, lon, distance, bearing) {
        const R = 6378137;
        const δ = distance / R;
        const θ = (bearing * Math.PI) / 180;
        const φ1 = (lat * Math.PI) / 180;
        const λ1 = (lon * Math.PI) / 180;

        const sinφ1 = Math.sin(φ1);
        const cosφ1 = Math.cos(φ1);
        const sinδ = Math.sin(δ);
        const cosδ = Math.cos(δ);
        const sinθ = Math.sin(θ);
        const cosθ = Math.cos(θ);

        const sinφ2 = sinφ1 * cosδ + cosφ1 * sinδ * cosθ;
        const φ2 = Math.asin(sinφ2);
        const y = sinθ * sinδ * cosφ1;
        const x = cosδ - sinφ1 * sinφ2;
        const λ2 = λ1 + Math.atan2(y, x);

        return {
          latitude: (φ2 * 180) / Math.PI,
          longitude: (((λ2 * 180) / Math.PI + 540) % 360) - 180,
        };
      }

      function updateStatus(message) {
        document.getElementById("info").textContent = message;
      }

      function initCompass() {
        const compassEl = document.getElementById("compass");
        compassEl.classList.remove("hidden");

        window.addEventListener(
          "deviceorientation",
          (e) => {
            if (e.webkitCompassHeading) {
              compassEl.style.transform = `rotate(${e.webkitCompassHeading}deg)`;
            } else if (e.alpha) {
              compassEl.style.transform = `rotate(${360 - e.alpha}deg)`;
            }
          },
          true
        );
      }

      function startDistanceUpdates() {
        setInterval(() => {
          if (!userLocation || !cubeEntity.components["gps-entity-place"])
            return;

          const cubePos = cubeEntity.components["gps-entity-place"].position;
          const distance = calculateDistance(
            userLocation.latitude,
            userLocation.longitude,
            cubePos.latitude,
            cubePos.longitude
          );

          // Get the cube element
          const cubeEl = document.getElementById("ar-cube");

          // Set the cube's position in the AR scene
          cubeEl.setAttribute("position", "0 1 -2");

          // Mark cube as placed
          isCubePlaced = true;

          // Update status and distance immediately
          updateStatus("Cube placed! You can now move around it.");
          updateDistanceIndicator();
        });
      }

      // Cleanup function
      function cleanup() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
        }
        if (distanceUpdateInterval !== null) {
          clearInterval(distanceUpdateInterval);
        }
      }

      // Handle page visibility changes
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          cleanup();
        } else {
          requestPermissions();
        }
      });

      // Initialize when A-Frame is ready
      document.querySelector("a-scene").addEventListener("loaded", function () {
        requestPermissions();
        updateStatus("AR Ready - Look around to see the red cube");

        // Place the cube after a short delay to ensure everything is initialized
        setTimeout(placeCube, 2000);
      });
    </script>
  </body>
</html>
