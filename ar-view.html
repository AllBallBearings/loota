<!DOCTYPE html>
<html>
  <head>
    <title>Loota AR View</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #info {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        z-index: 100;
        max-width: 80%;
      }
      #distance-indicator {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        z-index: 100;
      }
      #compass {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Arial, sans-serif;
        z-index: 100;
      }
      .hidden {
        display: none !important;
      }
      .a-enter-vr {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="info">Initializing AR...</div>
    <div id="distance-indicator" class="hidden">
      Distance to cube: calculating...
    </div>
    <div id="compass" class="hidden">N</div>

    <!-- Import libraries in correct order -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- A-Frame scene -->
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
    >
      <!-- Assets -->
      <a-assets>
        <a-asset-item
          id="grid"
          src="https://cdn.aframe.io/examples/ar/models/grid.gltf"
        ></a-asset-item>
      </a-assets>

      <!-- Red Cube -->
      <a-box
        position="0 1 -2"
        rotation="0 0 0"
        scale="0.3 0.3 0.3"
        material="color: #ff0000; metalness: 0.5; roughness: 0.5; emissive: #ff0000; emissiveIntensity: 0.2"
        animation="property: rotation; dur: 8000; to: 360 360 0; loop: true; easing: linear"
      ></a-box>

      <!-- Glow Effect -->
      <a-sphere
        position="0 0.8 -2"
        scale="0.1 0.02 0.1"
        material="color: #ff0000; opacity: 0.5; transparent: true"
        animation="property: scale; dir: alternate; dur: 1000; to: 0.15 0.02 0.15; loop: true"
      ></a-sphere>

      <!-- Camera -->
      <a-entity
        camera
        position="0 1.6 0"
        look-controls="touchEnabled: true"
      ></a-entity>
    </a-scene>

    <script>
      let userLocation = null;
      let watchId = null;
      let cubePosition = null;

      // Enhanced error messages
      const ERROR_MESSAGES = {
        CAMERA_PERMISSION:
          "Please grant camera access to view AR content. Refresh the page to try again.",
        LOCATION_PERMISSION:
          "Location access is needed to place the cube. Refresh the page to try again.",
        GENERIC:
          "An error occurred. Please check your device compatibility and try again.",
        ORIENTATION:
          "Please enable device orientation access for better AR experience.",
      };

      // Request necessary permissions with enhanced error handling
      async function requestPermissions() {
        try {
          updateStatus("Requesting permissions...");

          // Request location access with high accuracy
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            });
          });

          userLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          };

          // Start watching location for updates
          watchId = navigator.geolocation.watchPosition(
            updateUserLocation,
            null,
            { enableHighAccuracy: true }
          );

          updateStatus("Permissions granted. Looking for surfaces...");

          // Request device orientation permission for compass
          if (
            typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function"
          ) {
            try {
              await DeviceOrientationEvent.requestPermission();
              initCompass();
            } catch (e) {
              console.warn("Device orientation permission denied:", e);
            }
          } else {
            initCompass();
          }

          // Show distance indicator
          document
            .getElementById("distance-indicator")
            .classList.remove("hidden");
          updateDistanceIndicator();
        } catch (error) {
          console.error("Permission error:", error);
          if (error.name === "NotAllowedError") {
            updateStatus(ERROR_MESSAGES.LOCATION_PERMISSION);
          } else {
            updateStatus(ERROR_MESSAGES.GENERIC);
          }
        }
      }

      function updateStatus(message) {
        document.getElementById("info").innerHTML = message;
      }

      function updateUserLocation(position) {
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
        };
        updateDistanceIndicator();
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6378137; // Earth's radius in meters
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function updateDistanceIndicator() {
        if (!userLocation || !cubePosition) return;

        const distance = calculateDistance(
          userLocation.latitude,
          userLocation.longitude,
          cubePosition.latitude,
          cubePosition.longitude
        );

        const distanceEl = document.getElementById("distance-indicator");
        distanceEl.innerHTML = `Distance to cube: ${distance.toFixed(
          1
        )} meters`;
      }

      function initCompass() {
        const compassEl = document.getElementById("compass");
        compassEl.classList.remove("hidden");

        window.addEventListener(
          "deviceorientation",
          (event) => {
            if (event.webkitCompassHeading) {
              // iOS compass heading
              compassEl.style.transform = `rotate(${event.webkitCompassHeading}deg)`;
            } else if (event.alpha) {
              // Android compass heading
              compassEl.style.transform = `rotate(${360 - event.alpha}deg)`;
            }
          },
          true
        );
      }

      // Cleanup function
      function cleanup() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
        }
      }

      // Handle page visibility changes
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          cleanup();
        } else {
          requestPermissions();
        }
      });

      // Initialize when A-Frame is ready
      document.querySelector("a-scene").addEventListener("loaded", function () {
        requestPermissions();
        updateStatus("AR Ready - Look around to see the red cube");
      });
    </script>
  </body>
</html>
