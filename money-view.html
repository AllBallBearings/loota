<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>SLAM AR Object Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <link rel="stylesheet" href="app.css" />
    <style>
      /* Basic styling for AR button */
      #ar-button {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        z-index: 10;
      }
      #ar-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      /* Reticle styling */
      #reticle {
        position: absolute;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid white;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        opacity: 0.7;
        display: none; /* Hidden until AR session starts */
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden">
    <!-- AR Scene -->
    <a-scene
      id="ar-scene"
      webxr="requiredFeatures: hit-test,local-floor;
             optionalFeatures: dom-overlay;
             overlayElement: #overlay;"
      vr-mode-ui="enabled: false"
      renderer="antialias: true; alpha: true"
    >
      <!-- Camera - will be controlled by WebXR -->
      <a-camera></a-camera>

      <!-- Lights -->
      <a-light type="ambient" color="#BBB"></a-light>
      <a-light type="directional" position="-1 1 1" intensity="0.8"></a-light>

      <!-- Placeholder Object to place -->
      <a-box
        id="object-to-place"
        color="tomato"
        scale="0.2 0.2 0.2"
        position="0 -10 0"
        visible="false"
      ></a-box>

      <!-- Reticle/Cursor for hit-testing feedback (visualized in DOM) -->
      <!-- The actual hit-test logic is in JS -->
    </a-scene>

    <!-- DOM Overlay for UI -->
    <div id="overlay">
      <button id="ar-button" disabled>Start AR</button>
      <div id="reticle"></div>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const sceneEl = document.getElementById("ar-scene");
        const arButton = document.getElementById("ar-button");
        const reticleEl = document.getElementById("reticle");
        const objectToPlace = document.getElementById("object-to-place");
        let xrSession = null;
        let xrRefSpace = null;
        let xrHitTestSource = null;
        let objectPlaced = false;

        // Check for WebXR support
        if (navigator.xr) {
          navigator.xr.isSessionSupported("immersive-ar").then((supported) => {
            if (supported) {
              arButton.disabled = false;
              arButton.textContent = "Start AR";
              arButton.addEventListener("click", onButtonClicked);
            } else {
              arButton.textContent = "AR Not Supported";
            }
          });
        } else {
          arButton.textContent = "WebXR Not Available";
        }

        function onButtonClicked() {
          if (!xrSession) {
            navigator.xr
              .requestSession("immersive-ar", {
                requiredFeatures: ["hit-test", "local-floor"],
                optionalFeatures: ["dom-overlay"],
                domOverlay: { root: document.querySelector("#overlay") },
              })
              .then(onSessionStarted, onRequestSessionError);
          } else {
            xrSession.end();
          }
        }

        function onSessionStarted(session) {
          xrSession = session;
          arButton.textContent = "Exit AR";
          reticleEl.style.display = "block"; // Show reticle

          session.addEventListener("end", onSessionEnded);

          // Get reference space
          session.requestReferenceSpace("local-floor").then((refSpace) => {
            xrRefSpace = refSpace;
            // Start hit testing
            session
              .requestHitTestSource({ space: xrRefSpace })
              .then((hitTestSource) => {
                xrHitTestSource = hitTestSource;
              });
          });

          // Start the A-Frame render loop within the XR session
          sceneEl.xrSession = session;
          sceneEl.renderer.xr.setReferenceSpaceType("local-floor");
          sceneEl.renderer.xr.setSession(session);

          // Add click listener for placing the object
          session.inputSources.addEventListener("select", onSelect);

          // Start the render loop
          session.requestAnimationFrame(onXRFrame);

          console.log("AR Session Started");
        }

        function onRequestSessionError(ex) {
          console.error("Failed to start AR session.", ex);
          arButton.textContent = "Failed to Start AR";
        }

        function onSessionEnded() {
          xrSession.removeEventListener("end", onSessionEnded);
          xrSession.inputSources.removeEventListener("select", onSelect);

          xrSession = null;
          xrRefSpace = null;
          xrHitTestSource = null;
          objectPlaced = false; // Allow placing again if session restarts

          arButton.textContent = "Start AR";
          reticleEl.style.display = "none"; // Hide reticle
          objectToPlace.setAttribute("visible", "false"); // Hide object
          objectToPlace.setAttribute("position", "0 -10 0"); // Reset position

          // Stop A-Frame's XR session handling
          sceneEl.renderer.xr.setSession(null);
          sceneEl.xrSession = null;

          console.log("AR Session Ended");
        }

        function onSelect(event) {
          if (
            objectToPlace &&
            !objectPlaced &&
            reticleEl.hasAttribute("data-hit-position")
          ) {
            const hitPosition = reticleEl
              .getAttribute("data-hit-position")
              .split(" ")
              .map(Number);
            const hitQuaternion = reticleEl
              .getAttribute("data-hit-orientation")
              .split(" ")
              .map(Number); // Use orientation if needed

            objectToPlace.setAttribute("position", {
              x: hitPosition[0],
              y: hitPosition[1],
              z: hitPosition[2],
            });
            // Optionally set orientation based on hitQuaternion if desired
            // objectToPlace.setAttribute('rotation', ...)

            objectToPlace.setAttribute("visible", "true");
            objectPlaced = true; // Place only once per session for this demo
            reticleEl.style.display = "none"; // Hide reticle after placing
            console.log("Object placed at:", hitPosition);
          }
        }

        function onXRFrame(time, frame) {
          if (!xrSession || !xrHitTestSource || objectPlaced) {
            if (xrSession) xrSession.requestAnimationFrame(onXRFrame); // Keep loop running even if object placed
            return;
          }

          const session = frame.session;
          session.requestAnimationFrame(onXRFrame); // Continue the loop

          const viewerPose = frame.getViewerPose(xrRefSpace);
          if (!viewerPose) return;

          const hitTestResults = frame.getHitTestResults(xrHitTestSource);

          if (hitTestResults.length > 0) {
            const hitPose = hitTestResults[0].getPose(xrRefSpace);

            // Update reticle position and orientation in the DOM (optional, could use an A-Frame entity too)
            // For simplicity, we store the hit data on the DOM element for the 'select' event
            const position = hitPose.transform.position;
            const orientation = hitPose.transform.orientation;
            reticleEl.setAttribute(
              "data-hit-position",
              `${position.x} ${position.y} ${position.z}`
            );
            reticleEl.setAttribute(
              "data-hit-orientation",
              `${orientation.x} ${orientation.y} ${orientation.z} ${orientation.w}`
            );
            reticleEl.style.borderColor = "lightgreen"; // Indicate valid hit
          } else {
            reticleEl.removeAttribute("data-hit-position");
            reticleEl.removeAttribute("data-hit-orientation");
            reticleEl.style.borderColor = "white"; // Indicate no hit
          }
        }
      });
    </script>
  </body>
</html>
